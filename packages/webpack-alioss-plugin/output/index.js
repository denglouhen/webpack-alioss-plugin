"use strict";var e=require("ansi-colors"),t=require("fancy-log"),i=require("fs"),s=require("path"),o=require("ali-oss"),n=require("cosmiconfig"),r=require("progress");function l(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=l(e),a=l(t),u=l(i),d=l(s),f=l(o),h=l(r);
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function p(e,t,i,s){return new(i||(i=Promise))((function(o,n){function r(e){try{c(s.next(e))}catch(e){n(e)}}function l(e){try{c(s.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}c((s=s.apply(e,t||[])).next())}))}const y=/YYYY|YY|MM|DD|HH|hh|mm|SS|ss/g,m=["01","02","03","04","05","06","07"];function g(e,t){return e in t}const v=function(e="",t="YYYYMMDDHHmm"){const i=function(e){return e instanceof Date?e:"string"==typeof e?(e=e.replace(/\-/g,"/"),new Date(e)):"number"==typeof e?new Date(e):new Date}(e),s=e=>e<10?"0"+e:e;return t.replace(y,(function(e){switch(e){case"YYYY":return i.getFullYear()+"";case"YY":return(i.getFullYear()+"").slice(2);case"MM":return s(i.getMonth()+1)+"";case"DD":return s(i.getDate())+"";case"HH":case"hh":return s(i.getHours())+"";case"mm":return s(i.getMinutes())+"";case"SS":case"ss":return s(i.getSeconds())+"";case"week":return m[i.getDay()];default:return" "}}))},A=y,Y=["oss.config.js","oss.config.json"];class w extends class{constructor(e){this.config={accessKeyId:"",accessKeySecret:"",region:"",bucket:"",prefix:"",exclude:[],deleteAll:!1,local:!1,output:"",limit:5,format:""},this.uploadSum=0,this.client={},this.assets={},this.paramOptions=e}static getFormat(e="YYYYMMDDhhmm"){if(!A.test(e))throw new Error("参数格式由纯数字或YYYY、YY、MM、DD、HH、hh、mm、SS、ss组成");return v(new Date,e)}init(e){return p(this,void 0,void 0,(function*(){const t=n.cosmiconfigSync("user-config",{searchPlaces:Y}).search(),i=null!==t;let s={};if(null!==t&&(s=t.config),!e&&!i)throw new Error(c.default.red(`请配置插件信息，配置${JSON.stringify(Y).replace(/\"|\'|]|\[/g,"")}或new时传入参数`));if("[object Object]"!==Object.prototype.toString.call(e)&&!i)throw new Error(c.default.red("传入配置信息应该是Object"));if(["accessKeyId","accessKeySecret","bucket","region"].some((t=>i?g(t,s)&&!s[t]:g(t,e)&&!e[t])))throw new Error(c.default.red("请填写正确的accessKeyId、accessKeySecret和bucket"));if(this.config=Object.assign({prefix:"",exclude:[],deleteAll:!1,local:!0,output:"",limit:5},e,s),this.config.format&&!/[0-9]+/.test(this.config.format))throw new Error("format应该是纯数字");this.client=new f.default(this.config)}))}upload(){return p(this,void 0,void 0,(function*(){this.config.format?yield this.delPrefixAssetsByLimit().catch((e=>{a.default(`\n${c.default.red.inverse(" ERROR ")} ${c.default.red(e)}\n`)})):this.config.deleteAll?yield this.delAllAssets().catch((e=>{a.default(`\n${c.default.red.inverse(" ERROR ")} ${c.default.red(e)}\n`)})):yield this.uploadAssets().catch((e=>{a.default(`\n${c.default.red.inverse(" ERROR ")} ${c.default.red(e)}\n`)}))}))}delFilterAssets(e){return p(this,void 0,void 0,(function*(){try{const t=[];t.push(e);let i=yield this.client.list({prefix:e,"max-keys":1e3});i.objects&&i.objects.forEach((e=>{t.push(e.name)})),Array.isArray(t)&&(i=yield this.client.deleteMulti(t,{quiet:!0}))}catch(e){a.default(c.default.red(`删除缓存文件失败! reason: ${e}`))}}))}delCacheAssets(){return p(this,void 0,void 0,(function*(){const e=this.config.format,t=[];try{const i=yield this.client.list({delimiter:"/","max-keys":1e3});if(i.prefixes&&i.prefixes.forEach((i=>{t.push(+i.slice(e.length+1,-1))})),t.length>1){const i=this.config.limit>3?this.config.limit-1:2,s=t.slice().sort(((e,t)=>t-e)).slice(i);yield this.asyncForEach(s,(t=>p(this,void 0,void 0,(function*(){yield this.delFilterAssets(`${e}/${t}`)}))))}yield this.uploadAssets()}catch(e){yield this.uploadAssets()}}))}asyncForEach(e,t){return p(this,void 0,void 0,(function*(){for(let i=0;i<e.length;i++)yield t(e[i],i)}))}delAllAssets(){return p(this,void 0,void 0,(function*(){try{const{prefix:e}=this.config;let t=yield this.client.list({prefix:e,"max-keys":1e3});t.objects&&(t=t.objects.map((e=>e.name))),Array.isArray(t)&&(t=yield this.client.deleteMulti(t,{quiet:!0})),yield this.uploadAssets()}catch(e){yield this.uploadAssets()}}))}handleDel(e){return p(this,void 0,void 0,(function*(){try{yield this.client.delete(e)}catch(t){return t.failObjectName=e,t}}))}deletePrefix(e){return p(this,void 0,void 0,(function*(){a.default(c.default.yellow(`删除线上目录: ${e}/`));const t=yield this.client.list({prefix:e,"max-keys":1e3});t.objects=t.objects||[],yield Promise.all(t.objects.map((e=>this.handleDel(e.name))))}))}delPrefixAssetsByLimit(){return p(this,void 0,void 0,(function*(){try{const e=yield this.client.list({delimiter:"/","max-keys":1e3});let t=[];e.prefixes.forEach((e=>{const i=e.slice(0,-1);i!==this.config.format&&/^\+?[1-9][0-9]*$/.test(i)&&t.push(Number(i))})),t=t.sort(((e,t)=>t-e)),t.length>this.config.limit&&(t=t.slice(this.config.limit,t.length+1),yield Promise.all(t.map((e=>this.deletePrefix(e))))),yield this.uploadAssets()}catch(e){yield this.uploadAssets()}}))}uploadAssets(){return p(this,void 0,void 0,(function*(){this.config.local?yield this.uploadLocale(this.config.output):yield this.asyncForEach(Object.keys(this.assets),(e=>p(this,void 0,void 0,(function*(){this.filterFile(e)&&(yield this.update(e,Buffer.from(this.assets[e].source(),"utf8")))}))))}))}filterFile(e){const{exclude:t}=this.config;return!t||Array.isArray(t)&&!t.some((t=>t.test(e)))||!Array.isArray(t)&&!t.test(e)}getFileName(e){return d.default.join(e).replace(/\\/g,"/")}update(e,t){return p(this,void 0,void 0,(function*(){const i=this.getFileName(e);try{200==+(yield this.client.put(i,t)).res.statusCode?this.uploadSum++:a.default(c.default.red(`${i}上传失败!`))}catch(e){a.default(c.default.red(`${i}上传失败! reason: ${e}`))}}))}uploadLocale(e){return p(this,void 0,void 0,(function*(){yield this.uploadLocaleBase(e,this.update.bind(this))}))}uploadLocaleBase(e,t){return p(this,void 0,void 0,(function*(){const i=u.default.readdirSync(e);yield this.asyncForEach(i,(i=>p(this,void 0,void 0,(function*(){const s=d.default.join(e,i);if(this.filterFile(s))if(u.default.lstatSync(s).isDirectory())yield this.uploadLocaleBase(s,t);else{const e=s.slice(this.config.output.length);"function"==typeof t&&(yield t(e,s))}}))))}))}}{init(e){const t=Object.create(null,{init:{get:()=>super.init}});return p(this,void 0,void 0,(function*(){if(yield t.init.call(this,this.paramOptions),!this.config.output&&this.config.local){const t=e.outputPath||e.options.output.path;if(!t)throw new Error(c.default.red("请配置output"));this.config.output=t}void 0===this.config.format&&(this.config.format=w.getFormat("YYMMDD"))}))}apply(e){return p(this,void 0,void 0,(function*(){if(yield this.init(e),!e.hooks)throw new Error(c.default.red("您的Webapck版本过低"));e.hooks.afterEmit.tapPromise("WebpackAliOSSPlugin",(e=>p(this,void 0,void 0,(function*(){let t=0;yield this.uploadLocaleBase(this.config.output,(()=>{t++}));const i=new h.default("正在上传 [:bar] :percent",{total:t,complete:"█",incomplete:"░",width:100});return Object.defineProperty(this,"uploadSum",{set:function(){i.tick(),i.complete&&a.default(`\n${c.default.green.inverse(" DONE ")} ${c.default.green("upload complete")}\n`)}}),yield this.uploads(e),Promise.resolve("finsh")}))))}))}uploads(e,t){const i=Object.create(null,{upload:{get:()=>super.upload}});return p(this,void 0,void 0,(function*(){if(void 0===e)return this.uploadAssets();this.assets=e.assets,yield i.upload.call(this),"function"==typeof t&&t()}))}}module.exports=w;
